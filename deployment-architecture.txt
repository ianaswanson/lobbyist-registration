================================================================================
                   CLOUD BUILD DEPLOYMENT ARCHITECTURE
================================================================================

DEVELOPMENT ENVIRONMENT (Auto-Deploy)
================================================================================

┌─────────────┐      ┌──────────────────┐      ┌─────────────────┐
│             │      │                  │      │                 │
│   GitHub    │      │   Cloud Build    │      │   Cloud Run     │
│  (develop)  │──────▶   (Triggered)    │──────▶   Development   │
│             │ push │                  │deploy│                 │
└─────────────┘      └──────────────────┘      └─────────────────┘
                              │
                              │ Runs pipeline:
                              │
                     ┌────────┴────────┐
                     │                 │
                     │  1. npm ci      │
                     │  2. Type check  │
                     │  3. Security    │
                     │     scan        │
                     │  4. Build image │
                     │  5. Push to GCR │
                     │  6. Deploy      │
                     │  7. Verify      │
                     │                 │
                     └─────────────────┘
                              │
                              ▼
                      ✅ Auto-deployed
                      ~5 minutes total

Service URL: https://lobbyist-registration-dev-zzp44w3snq-uw.a.run.app


PRODUCTION ENVIRONMENT (Manual Approval)
================================================================================

┌─────────────┐      ┌──────────────────┐      ┌─────────────┐
│             │      │                  │      │             │
│   GitHub    │      │   Cloud Build    │      │   WAITING   │
│    (main)   │──────▶   (Triggered)    │──────▶   FOR YOU   │
│             │ push │                  │      │  TO APPROVE │
└─────────────┘      └──────────────────┘      └─────────────┘
                              │                        │
                              │ Runs validation:       │
                              │                        │
                     ┌────────┴────────┐               │
                     │                 │               │
                     │  1. npm ci      │               │
                     │  2. Type check  │               │
                     │  3. Security    │               │
                     │     audit       │               │
                     │     (strict)    │               │
                     │  4. Validate    │               │
                     │     schema      │               │
                     │  5. Build image │               │
                     │  6. Scan image  │               │
                     │  7. Push to GCR │               │
                     │                 │               │
                     └─────────────────┘               │
                              │                        │
                              ▼                        │
                    ⏸️  PAUSED FOR APPROVAL ◀──────────┘
                         (You review)
                              │
                              │ You approve in console
                              ▼
                     ┌─────────────────┐
                     │                 │
                     │  8. Tag image   │
                     │  9. Deploy      │
                     │     (no traffic)│
                     │ 10. Health      │
                     │     check       │
                     │ 11. Route       │
                     │     traffic     │
                     │ 12. Verify      │
                     │                 │
                     └─────────────────┘
                              │
                              ▼
                      ✅ Deployed to production
                      ~10 minutes total

Service URL: https://lobbyist-registration-zzp44w3snq-uw.a.run.app


ROLLBACK PROCEDURE
================================================================================

┌─────────────────────────────────────────────────────────────┐
│                                                               │
│  Production has multiple revisions (blue-green deployment):  │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Revision A  │  │  Revision B  │  │  Revision C  │       │
│  │  (previous)  │  │  (previous)  │  │  (current)   │       │
│  │              │  │              │  │  100% traffic│       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                              │                │
│                                              │ If broken      │
│                                              ▼                │
│                            ┌─────────────────────────┐        │
│                            │  Rollback to Revision B │        │
│                            └─────────────────────────┘        │
│                                              │                │
│                                              ▼                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Revision A  │  │  Revision B  │  │  Revision C  │       │
│  │              │  │  100% traffic│  │  (removed)   │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                               │
└─────────────────────────────────────────────────────────────┘

Command:
  gcloud run services update-traffic lobbyist-registration \
    --region=us-west1 \
    --to-revisions=REVISION_B=100


COMPARISON: Connect Repo vs Cloud Build
================================================================================

CONNECT REPO (Simple but Risky):

  GitHub ──────▶ Cloud Run
  (main)      instant deploy
                    │
                    ▼
              ❌ NO VALIDATION
              ❌ NO APPROVAL
              ❌ NO AUDIT TRAIL
              ❌ RISKY FOR PRODUCTION


CLOUD BUILD TRIGGERS (Recommended):

  GitHub ──────▶ Cloud Build ──────▶ [APPROVAL] ──────▶ Cloud Run
  (main)      validate/build      you review       safe deploy
                    │                                     │
                    │                                     ▼
                    │                            ✅ VALIDATED
                    ▼                            ✅ APPROVED
              ✅ TYPE CHECK                      ✅ AUDITABLE
              ✅ SECURITY SCAN                   ✅ SAFE
              ✅ BUILD LOGS
              ✅ AUDIT TRAIL


SECURITY MODEL
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│                                                                   │
│  Cloud Build Service Account                                     │
│  (runs with least-privilege permissions)                         │
│                                                                   │
│  ┌─────────────────┐                                             │
│  │  Permissions:   │                                             │
│  │                 │                                             │
│  │  ✅ Deploy to   │──────────┐                                  │
│  │    Cloud Run    │          │                                  │
│  │                 │          │                                  │
│  │  ✅ Push to     │          │                                  │
│  │    Container    │          │                                  │
│  │    Registry     │          ▼                                  │
│  │                 │    ┌──────────────┐                         │
│  │  ✅ Access      │    │              │                         │
│  │    Secret       │────│  Cloud Run   │                         │
│  │    Manager      │    │  Production  │                         │
│  │                 │    │              │                         │
│  │  ❌ No access   │    └──────────────┘                         │
│  │    to user      │                                             │
│  │    data or      │                                             │
│  │    billing      │                                             │
│  │                 │                                             │
│  └─────────────────┘                                             │
│                                                                   │
│  🔒 No GCP credentials stored in GitHub                          │
│  🔒 All secrets in Secret Manager (encrypted at rest)            │
│  🔒 Audit logs capture every action                              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘


COST BREAKDOWN
================================================================================

Cloud Build Free Tier: 120 build-minutes/day

Your expected usage:

┌──────────────────┬──────────────┬─────────────┬──────────────┐
│ Environment      │ Frequency    │ Build Time  │ Monthly Use  │
├──────────────────┼──────────────┼─────────────┼──────────────┤
│ Development      │ 2-3/day      │ 5 min       │ 300-450 min  │
│ Production       │ 1-2/week     │ 7 min       │ 28-56 min    │
│ Total            │              │             │ ~500 min     │
└──────────────────┴──────────────┴─────────────┴──────────────┘

Free tier capacity: 3,600 min/month
Your usage:          ~500 min/month
Remaining:          3,100 min/month

COST: $0 (within free tier) 💰


AUDIT TRAIL EXAMPLE
================================================================================

Every deployment captures:

┌─────────────────────────────────────────────────────────────────┐
│ Deployment Record ID: 2025-10-21-143022-abc123                  │
├─────────────────────────────────────────────────────────────────┤
│ WHO:                                                             │
│   GitHub User: ianaswanson                                       │
│   Service Account: cloudbuild@project.iam.gserviceaccount.com   │
│   Approver: ianaswanson (production only)                        │
│                                                                  │
│ WHAT:                                                            │
│   Commit: abc123def456                                           │
│   Branch: main                                                   │
│   Files Changed: 5 files                                         │
│   Lines: +127, -43                                               │
│                                                                  │
│ WHEN:                                                            │
│   Triggered: 2025-10-21 14:30:22 UTC                             │
│   Approved: 2025-10-21 14:35:15 UTC                              │
│   Deployed: 2025-10-21 14:40:33 UTC                              │
│                                                                  │
│ WHY:                                                             │
│   Commit Message: "feat: Add new expense category field"        │
│                                                                  │
│ HOW:                                                             │
│   Build Steps: 13 steps (all passed)                             │
│   Image: gcr.io/project/lobbyist-registration:abc123            │
│   Revision: lobbyist-registration-00042-xyz                      │
│                                                                  │
│ RESULT:                                                          │
│   Status: ✅ SUCCESS                                             │
│   Health Check: ✅ PASSED                                        │
│   Traffic: 100% to new revision                                  │
│                                                                  │
│ LOGS:                                                            │
│   Build: https://console.cloud.google.com/build/abc123          │
│   Service: https://console.cloud.google.com/run/detail/...      │
└─────────────────────────────────────────────────────────────────┘

This audit trail is retained for 90 days and can be exported for
compliance reports required by Multnomah County.


NEXT STEPS
================================================================================

1. Read DEPLOYMENT-RECOMMENDATION.md for complete details

2. Connect GitHub repository to Cloud Build

3. Run setup script:
   cd /Users/ianswanson/ai-dev/lobbyist-registration
   ./setup-cloud-build-triggers.sh

4. Test development deployment

5. Test production approval workflow

6. Document any project-specific customizations


================================================================================
